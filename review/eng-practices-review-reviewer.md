### Review 最佳实践（Reviewer）

#### Review 标准

Reviewer 的责任是保证每个提交在不断地提高项目代码的可维护性和健壮性，即使单个提交不那么完美，没有完美的代码，只有更好的代码。

- 指导

    Review 的过程就是学习交流的过程，Reviewer 的反馈要用技术指导的语气，而不是命令口吻。

- 原则

    - 一切代码风格以代码规范为准，否则接受开发者的代码风格。
    - 代码设计结构应该遵循标准的软件设计原则，否则接受开发者的设计原则。
    - 其余的 Reviewer 可以要求和现有代码保持一致。

- 解决冲突

    - 根据 Review 原则双方达成一致。
    - 如果很难达成一致，有必要面对面 Review 达成一致，并把讨论结论记录 Review 工具中，以备其它开发者查阅。
    - 如果还不能达成一致，需要进行团队讨论，或者由 Leader 做决定。



#### Review 的关注点

- 设计

    合理性、可行性

- 功能

    - 确保提交的修改是符合预期的。
    - Reviewer 阅读代码时需要考虑边界情况。
    - 像用户一样使用软件来检查，比如是影响到UI的提交，只看代码是很难发现的。
    - 当提交中有并发代码，要特别小心死锁和竞争条件，需要仔细 review。当有可能产生死锁和竞争条件时不建议采用并发方案。

- 复杂度

    - 尽可能降低代码复杂度，保证简单好理解。
    - 避免过度设计。
    - 解决眼前问题，而不是将来可能出现的问题。

- 测试

    - 通常代码修改需要和功能修改在一个提交中。
    - 确保测试的正确性。
    - 确保测试的有效性。
    - 要把测试看作业务代码维护。

- 命名

    好的命名，需要长到可以表达所代表的意思，但又不至于长到难以阅读。

- 评论

    - 表达清楚意思，只在需要的时候出现，不要滥用。
    - 通常只表达代码为什么这么写？而不是代码做了什么？
    - 当有代码不能表达的复杂算法或操作时（这种情况很少），通过注释表达做了什么？
    - 代码中包含的意思，注释不需要重复表达。
    - 还要注意代码中现有的注释。
    - 注释和文档不一样。

- 风格

    - 和代码风格规范统一。
    - 非规范的优化点作为可选的，不能延迟合入提交。
    - 代码风格优化和功能提交应该分在不同的提交中。

- 文档

    确保文档和提交同时更新。

- 仔细 Review

    - 生成的代码、数据类有时可以跳着看，但开发者写的代码需要一行行仔细看。
    - 当代码很难阅读读懂时，让开发者先把代码梳理清楚后再 review。
    - 针对一些复杂问题，比如安全、并发等，如果 review 比较吃力，可以委托给别的同事。

- 上下文

    - Review 的时候需要结合代码上下文一起 review。
    - 要把提交放在整个软件系统中去 review，仔细考虑这个提交对整个系统的影响好坏。

- 好的地方

    在 Review 过程中发现做的特别好的地方要及时夸奖开发者，而不是只挑刺。

- 总结

    - 设计合理
    - 功能对用户简单可用
    - 界面修改符合预期
    - 并发程序确认运行安全
    - 避免过度设计
    - 只解决当前问题
    - 需要单元测试
    - 测试代码也需要设计合理
    - 命名清楚好理解简洁明了
    - 文档及时更新
    - 符合规范
    - 把修改放在整体里审查
    - 及时夸奖



#### Review 的顺序

- 概括
    - 这个提交修改合理吗？提交描述清楚吗？
    - 提交的重点部分设计合理吗？
    - 剩余部分合理吗？
- 第一步：总体上浏览
    - 如果发现这个提交不应该被提交，应该及时反馈给开发者并提供另一个方案
    - 拒绝提交的时候态度尽量友好，尊重对方。
    - 反思工作流程，防止出现整个提交被拒的情况。
- 第二步：检查主要部分
    - 先找出主要修改文件 review，如果找不出就询问开发者，或者考虑让他拆分提交。
    - 主要部分有问题需要修改，应立即反馈给开发者，不需要看完剩余部分。
    - 主要部分遇到问题需要及时反馈的原因
        - 防止下一个基于本提交的提交将来返工的太多。
        - 修改主要部分需要更多时间，及时反馈防止超过工期。
- 第三步：查看剩余部分
    - 不要漏看任何一个文件。
    - 可以先看测试代码，清楚业务代码的目的。

#### Review 的速度

- 为什么 review 需要尽快？

    - review 慢的问题？
        - 整个团队的速度会被拖慢。
        - 开发者就回抵触提 pr，大部分关于 review 的抱怨会被快速的 review 解决。
        - 影响代码进一步的重构和优化。

- Review 的速度应该多快？

    - 手头没有重要的需求在开发，应该立马 review pr。
    - 最晚隔一个工作日去 review。
    - 一天以内 review 需要往返几次。

- 尽快 review 还是中断当前工作

    如果正在全神贯注地进行一个工作，不要中断去 review 代码，而是等一个空闲期去 review。比如，写完一个需求、开完会、午饭后等，因为重新回归高度集中的工作中比让一个 review 等一会对团队来说更加昂贵。

- 快速反应

    我们这里说的快速指的是 reviewer 快速反馈，而不是让提交快速的合进去。审查代码的过程还是需要花费足够的时间确保代码的质量达到我们的要求。

- 提前同意合入

    - 当遇到下面这两种情况时，为了尽快 review 可以忽略一部分未解决的问题先合入 pr，但 reviewer 要在评论里备注清楚：

        - reviewer 相信开发者后面能自己修复。
        - 问题不大，不是必须由开发者修复的。

        这种情况主要针对跨时区 review，我们不太会遇到。

- 修改量大的提交

    - 让开发者拆分提交/PR。
    - 不能拆分且 reviewer 没有时间去 review，现在从总体着眼做一些评论，和提供几个让开发者可以优化的点。总之，就是不能阻塞开发者的工作，并且快速提供下一步的指示。

加快 review 的速度不能以牺牲代码质量为代价，因为长期来看这并不快。

#### 如何写 review 反馈

- 概括

    - 善意。
    - 解释原因。
    - 平衡好「给出明确的修改方向」和「指出问题，让开发者自己决定如何修改」两个选项。
    - 鼓励开发者简化代码和添加代码注释，取代单纯通过评论或口述解释代码的复杂含义。

- 善意

    指出问题时，仅针对代码发表评论，而不是开发者本人。

- 解释

    指出某一处代码有问题时，尽量解释这个结论背后的原因，帮助开发者理解你的观点。

- 给出指导

    - 添加一个功能或者修复一个 bug 是开发者的责任，不是 reviewer 的，reviewer 没有责任提供详细的解决方案。
    - 需要平衡好「提供直接解决方案」和「让开发者自己想办法解决」两种选项，后者更能促进开发者的进步。
    - 然而有时直接的提示甚至代码更有用些，review 的首要目标是提高代码质量，次要目标是提高开发者能力。

- 接受解释

    - 对一段代码看不懂，最好让开发者梳理逻辑，重写这部分代码，而不是在 review 工具中解释。因为这样的话，别的开发者将来也开不懂这段代码。
    - 可以接受在 review 工具中通过评论解释的情况：你对这段代码不熟悉，开发者解释给你帮助理解的信息，别的开发者都了解。

#### 处理开发者对 review 反馈的反对

- 谁是对的？

    - 充分考虑开发者是不是对的，毕竟开发者更熟悉代码，如果开发者是对的，及时告诉他们并撤销之前的 review 反馈。
    - 如果开发者不对，reviewer 需要进一步解释。这里的解释应该包括对开发者回复的理解和为什么 review 反馈正确的理由。
    - 如果 review 反馈是有利于代码质量的提高，reviewer 应该坚持，因为单次的修改可能不那么容易看出来。

- 使开发者不开心

    Reviewer 或许会担心坚持对一些代码的优化需求会让开发者不开心，其实只要评论交流注意态度语气，开发者是不会生气的。

- 稍后在修

    - 尽量不要允许将一些小问题延迟至后面再修，reviewer 应该坚持在当前 pr 里修复，因为开发者很有可能会忘记。
    - 如果遇到暂时不能修复的问题，则应将新问题通过 bug 跟踪，防止遗忘。

- Review 太严格的抱怨

    - 对 review 的快速反应有助于消除这种抱怨。
    - 当大家看到严格 review 的好处自然不会再抱怨。

